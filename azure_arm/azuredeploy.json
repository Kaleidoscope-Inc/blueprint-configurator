{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "kaleidoscope-blueprint-rg"
    },
    "resourceGroupLocation": { "type": "string", "defaultValue": "eastus" },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "k6scopemystorageaccount"
    },
    "storageContainerName": {
      "type": "string",
      "defaultValue": "kaleidoscopeactivitylogscontainer"
    },
    "storageQueueName": {
      "type": "string",
      "defaultValue": "kaleidoscopeactivitylogsqueue"
    },
    "applicationDisplayName": {
      "type": "string",
      "defaultValue": "kaleidoscope-blueprint"
    },
    "userAssignedIdentityName": {
      "type": "string",
      "defaultValue": "kaleidoscope-deployment-identity"
    }
  },
  "variables": {
    "nestedDeploymentName": "kaleidoscope-nested-deployment"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('resourceGroupLocation')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "[variables('nestedDeploymentName')]",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "storageContainerName": {
            "value": "[parameters('storageContainerName')]"
          },
          "storageQueueName": { "value": "[parameters('storageQueueName')]" },
          "applicationDisplayName": {
            "value": "[parameters('applicationDisplayName')]"
          },
          "userAssignedIdentityName": {
            "value": "[parameters('userAssignedIdentityName')]"
          },
          "resourceGroupLocation": {
            "value": "[parameters('resourceGroupLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "storageAccountName": { "type": "string" },
            "storageContainerName": { "type": "string" },
            "storageQueueName": { "type": "string" },
            "applicationDisplayName": { "type": "string" },
            "userAssignedIdentityName": { "type": "string" },
            "resourceGroupLocation": { "type": "string" }
          },
          "variables": {
            "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
            "userAssignedIdentityResourceId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('userAssignedIdentityName')]",
              "location": "[parameters('resourceGroupLocation')]"
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('resourceGroupLocation')]",
              "sku": { "name": "Standard_LRS" },
              "kind": "StorageV2",
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[concat(parameters('storageAccountName'), '/default/', parameters('storageContainerName'))]",
              "dependsOn": ["[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
              "apiVersion": "2023-01-01",
              "name": "[concat(parameters('storageAccountName'), '/default/', parameters('storageQueueName'))]",
              "dependsOn": ["[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[concat(variables('storageAccountId'), '/blobServices/default')]",
              "name": "kaleidoscope-storage-account-logs",
              "dependsOn": ["[variables('storageAccountId')]"],
              "properties": {
                "storageAccountId": "[variables('storageAccountId')]",
                "logs": [
                  {
                    "category": "StorageRead",
                    "enabled": true
                  },
                  {
                    "category": "StorageWrite",
                    "enabled": true
                  },
                  {
                    "category": "StorageDelete",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "createAzureAdAppAndAssignRole",
              "location": "[parameters('resourceGroupLocation')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[variables('userAssignedIdentityResourceId')]": {}
                }
              },
              "dependsOn": [
                "[variables('userAssignedIdentityResourceId')]"
              ],
              "properties": {
                "azCliVersion": "2.52.0",
                "timeout": "PT30M",
                "retentionInterval": "P1D",
                "cleanupPreference": "OnSuccess",
                "scriptContent": "#!/bin/bash\nset -euo pipefail\n\n# Get tenant ID for root management group\nTENANT_ID=$(az account show --query tenantId -o tsv)\n\n# Microsoft Graph App ID\nMSGRAPH_APP_ID='00000003-0000-0000-c000-000000000000'\n\n# Check for existing app or create new one\nAPP_ID=$(az ad app list --display-name \"$APP_DISPLAY_NAME\" --query '[0].appId' -o tsv)\nif [ -z \"$APP_ID\" ] || [ \"$APP_ID\" = \"null\" ]; then\n  APP_ID=$(az ad app create --display-name \"$APP_DISPLAY_NAME\" --query appId -o tsv)\nfi\n\n# Get permission IDs for Microsoft Graph\nUSER_READ_ALL=$(az ad sp show --id \"$MSGRAPH_APP_ID\" --query \"appRoles[?value=='User.Read.All'].id\" -o tsv)\nGROUP_READ_ALL=$(az ad sp show --id \"$MSGRAPH_APP_ID\" --query \"appRoles[?value=='Group.Read.All'].id\" -o tsv)\nROLE_MGMT_READ_ALL=$(az ad sp show --id \"$MSGRAPH_APP_ID\" --query \"appRoles[?value=='RoleManagement.Read.All'].id\" -o tsv)\n\n# Add Microsoft Graph permissions\naz ad app permission add --id \"$APP_ID\" --api \"$MSGRAPH_APP_ID\" --api-permissions \"$USER_READ_ALL=Role\" 2>/dev/null || true\naz ad app permission add --id \"$APP_ID\" --api \"$MSGRAPH_APP_ID\" --api-permissions \"$GROUP_READ_ALL=Role\" 2>/dev/null || true\naz ad app permission add --id \"$APP_ID\" --api \"$MSGRAPH_APP_ID\" --api-permissions \"$ROLE_MGMT_READ_ALL=Role\" 2>/dev/null || true\n\n# Check for existing service principal or create new one\nSP_ID=$(az ad sp list --filter \"appId eq '$APP_ID'\" --query '[0].id' -o tsv)\nif [ -z \"$SP_ID\" ] || [ \"$SP_ID\" = \"null\" ]; then\n  SP_ID=$(az ad sp create --id \"$APP_ID\" --query id -o tsv)\nfi\n\n# Reset/create client secret\nCLIENT_SECRET=$(az ad app credential reset --id \"$APP_ID\" --query password -o tsv)\n\n# Assign Reader role at subscription scope if not already assigned\nEXISTING_ROLE=$(az role assignment list --assignee $SP_ID --role Reader --scope /subscriptions/$SUBSCRIPTION_ID --query '[0].id' -o tsv)\nif [ -z \"$EXISTING_ROLE\" ] || [ \"$EXISTING_ROLE\" = \"null\" ]; then\n  az role assignment create --assignee $SP_ID --role Reader --scope /subscriptions/$SUBSCRIPTION_ID\nfi\n\n# Assign Management Group Reader role at root management group scope if not already assigned\nMG_SCOPE=\"/providers/Microsoft.Management/managementGroups/$TENANT_ID\"\nEXISTING_MG_ROLE=$(az role assignment list --assignee $SP_ID --role \"Management Group Reader\" --scope \"$MG_SCOPE\" --query '[0].id' -o tsv 2>/dev/null || echo \"\")\nif [ -z \"$EXISTING_MG_ROLE\" ] || [ \"$EXISTING_MG_ROLE\" = \"null\" ]; then\n  az role assignment create --assignee $SP_ID --role \"Management Group Reader\" --scope \"$MG_SCOPE\" 2>/dev/null || echo \"Warning: Could not assign Management Group Reader role. Managed identity lacks User Access Administrator at management group scope. Assign this role manually.\"\nfi\n\n# Assign AcrPull and AcrReader roles to all ACR registries in the subscription\nACR_REGISTRIES=$(az acr list --subscription $SUBSCRIPTION_ID --query '[].{id:id}' -o tsv)\nfor ACR_ID in $ACR_REGISTRIES; do\n  for ROLE in AcrPull AcrReader; do\n    EXISTING_ACR_ROLE=$(az role assignment list --assignee $SP_ID --role $ROLE --scope $ACR_ID --query '[0].id' -o tsv 2>/dev/null || echo \"\")\n    if [ -z "$EXISTING_ACR_ROLE" ] || [ "$EXISTING_ACR_ROLE" = "null" ]; then\n      az role assignment create --assignee $SP_ID --role $ROLE --scope $ACR_ID\n    fi\n  done\ndone\n\necho \"{\\\"clientId\\\":\\\"$APP_ID\\\",\\\"clientSecret\\\":\\\"$CLIENT_SECRET\\\",\\\"servicePrincipalObjectId\\\":\\\"$SP_ID\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH",
                "environmentVariables": [
                  {
                    "name": "APP_DISPLAY_NAME",
                    "value": "[parameters('applicationDisplayName')]"
                  },
                  {
                    "name": "SUBSCRIPTION_ID",
                    "value": "[subscription().subscriptionId]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "storageContainerName": {
              "type": "string",
              "value": "[parameters('storageContainerName')]"
            },
            "storageQueueName": {
              "type": "string",
              "value": "[parameters('storageQueueName')]"
            },
            "storageAccountKey": {
              "type": "string",
              "value": "[listKeys(variables('storageAccountId'), '2023-01-01').keys[0].value]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference('createAzureAdAppAndAssignRole').outputs.clientId]"
            },
            "clientSecret": {
              "type": "string",
              "value": "[reference('createAzureAdAppAndAssignRole').outputs.clientSecret]"
            },
            "servicePrincipalObjectId": {
              "type": "string",
              "value": "[reference('createAzureAdAppAndAssignRole').outputs.servicePrincipalObjectId]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "tenantId": { "type": "string", "value": "[subscription().tenantId]" },
    "subscriptionId": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "storageQueueName": {
      "type": "string",
      "value": "[parameters('storageQueueName')]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(variables('nestedDeploymentName')).outputs.storageAccountName.value]"
    },
    "storageAccountKey": {
      "type": "string",
      "value": "[reference(variables('nestedDeploymentName')).outputs.storageAccountKey.value]"
    },
    "clientId": {
      "type": "string",
      "value": "[reference(variables('nestedDeploymentName')).outputs.clientId.value]"
    },
    "clientSecret": {
      "type": "string",
      "value": "[reference(variables('nestedDeploymentName')).outputs.clientSecret.value]"
    },
    "servicePrincipalObjectId": {
      "type": "string",
      "value": "[reference(variables('nestedDeploymentName')).outputs.servicePrincipalObjectId.value]"
    }
  }
}
