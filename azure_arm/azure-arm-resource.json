{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "managedIdentityName": {
      "type": "string",
      "defaultValue": "kaleidoscope-deployment-identity",
      "metadata": {
        "description": "Name of the managed identity created in the first template (e.g., 'kaleidoscope-deployment-identity')"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "k6scopemystorageaccount",
      "metadata": {
        "description": "Name of the storage account (must be globally unique)"
      }
    },
    "storageContainerName": {
      "type": "string",
      "defaultValue": "kaleidoscopeactivitylogscontainer",
      "metadata": {
        "description": "Name of the blob container"
      }
    },
    "storageQueueName": {
      "type": "string",
      "defaultValue": "kaleidoscopeactivitylogsqueue",
      "metadata": {
        "description": "Name of the storage queue"
      }
    },
    "applicationDisplayName": {
      "type": "string",
      "defaultValue": "kaleidoscope-blueprint",
      "metadata": {
        "description": "Display name for the Azure AD application"
      }
    }
  },
  "variables": {
    "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
    "managedIdentityResourceId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-01-01",
      "name": "[concat(parameters('storageAccountName'), '/default/', parameters('storageContainerName'))]",
      "dependsOn": [
        "[variables('storageAccountId')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
      "apiVersion": "2023-01-01",
      "name": "[concat(parameters('storageAccountName'), '/default/', parameters('storageQueueName'))]",
      "dependsOn": [
        "[variables('storageAccountId')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2023-08-01",
      "name": "createAzureAdAppAndAssignRoles",
      "location": "[resourceGroup().location]",
      "kind": "AzureCLI",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[variables('managedIdentityResourceId')]": {}
        }
      },
      "dependsOn": [
        "[variables('storageAccountId')]"
      ],
      "properties": {
        "azCliVersion": "2.52.0",
        "timeout": "PT30M",
        "retentionInterval": "P1D",
        "cleanupPreference": "OnSuccess",
        "scriptContent": "#!/bin/bash\nset -e\n\necho \"======================================\"\necho \"Starting Azure AD App Deployment Script\"\necho \"======================================\"\n\n# Validate required environment variables\nif [ -z \"$APP_DISPLAY_NAME\" ]; then\n  echo \"ERROR: APP_DISPLAY_NAME is not set\"\n  exit 1\nfi\n\nif [ -z \"$SUBSCRIPTION_ID\" ]; then\n  echo \"ERROR: SUBSCRIPTION_ID is not set\"\n  exit 1\nfi\n\n# Get tenant ID\necho \"Retrieving tenant information...\"\nTENANT_ID=$(az account show --query tenantId -o tsv)\nif [ -z \"$TENANT_ID\" ]; then\n  echo \"ERROR: Failed to retrieve tenant ID\"\n  exit 1\nfi\n\necho \"Tenant ID: $TENANT_ID\"\necho \"Subscription ID: $SUBSCRIPTION_ID\"\necho \"Application Display Name: $APP_DISPLAY_NAME\"\n\n# Microsoft Graph App ID\nMSGRAPH_APP_ID='00000003-0000-0000-c000-000000000000'\n\n# Check for existing app or create new one\necho \"\"\necho \"Checking for existing application: $APP_DISPLAY_NAME\"\nAPP_ID=$(az ad app list --display-name \"$APP_DISPLAY_NAME\" --query '[0].appId' -o tsv 2>&1)\nif [ -z \"$APP_ID\" ] || [ \"$APP_ID\" = \"null\" ]; then\n  echo \"Creating new application...\"\n  APP_ID=$(az ad app create --display-name \"$APP_DISPLAY_NAME\" --query appId -o tsv 2>&1)\n  if [ -z \"$APP_ID\" ] || [ \"$APP_ID\" = \"null\" ]; then\n    echo \"ERROR: Failed to create application\"\n    exit 1\n  fi\n  echo \"✓ Created application with ID: $APP_ID\"\nelse\n  echo \"✓ Found existing application with ID: $APP_ID\"\nfi\n\n# Get permission IDs for Microsoft Graph\necho \"\"\necho \"Retrieving Microsoft Graph permission IDs...\"\nUSER_READ_ALL=$(az ad sp show --id \"$MSGRAPH_APP_ID\" --query \"appRoles[?value=='User.Read.All'].id\" -o tsv 2>&1)\nGROUP_READ_ALL=$(az ad sp show --id \"$MSGRAPH_APP_ID\" --query \"appRoles[?value=='Group.Read.All'].id\" -o tsv 2>&1)\nROLE_MGMT_READ_ALL=$(az ad sp show --id \"$MSGRAPH_APP_ID\" --query \"appRoles[?value=='RoleManagement.Read.All'].id\" -o tsv 2>&1)\n\nif [ -z \"$USER_READ_ALL\" ] || [ -z \"$GROUP_READ_ALL\" ] || [ -z \"$ROLE_MGMT_READ_ALL\" ]; then\n  echo \"ERROR: Failed to retrieve Microsoft Graph permission IDs\"\n  exit 1\nfi\n\necho \"✓ Retrieved permission IDs\"\n\n# Add Microsoft Graph permissions\necho \"\"\necho \"Adding Microsoft Graph permissions...\"\nset +e\naz ad app permission add --id \"$APP_ID\" --api \"$MSGRAPH_APP_ID\" --api-permissions \"${USER_READ_ALL}=Role\" 2>&1 | grep -v \"already exists\" || true\naz ad app permission add --id \"$APP_ID\" --api \"$MSGRAPH_APP_ID\" --api-permissions \"${GROUP_READ_ALL}=Role\" 2>&1 | grep -v \"already exists\" || true\naz ad app permission add --id \"$APP_ID\" --api \"$MSGRAPH_APP_ID\" --api-permissions \"${ROLE_MGMT_READ_ALL}=Role\" 2>&1 | grep -v \"already exists\" || true\nset -e\necho \"✓ Permissions added\"\n\n# Grant admin consent for the permissions (non-critical)\necho \"\"\necho \"Attempting to grant admin consent...\"\nset +e\naz ad app permission admin-consent --id \"$APP_ID\" 2>&1\nCONSENT_RESULT=$?\nset -e\nif [ $CONSENT_RESULT -eq 0 ]; then\n  echo \"✓ Admin consent granted successfully\"\nelse\n  echo \"⚠️  WARNING: Could not grant admin consent automatically\"\n  echo \"   You may need to grant this manually in Azure Portal\"\n  echo \"   Requires: Global Administrator, Privileged Role Administrator, or Cloud Application Administrator role\"\nfi\n\n# Check for existing service principal or create new one\necho \"\"\necho \"Checking for service principal...\"\nSP_ID=$(az ad sp list --filter \"appId eq '$APP_ID'\" --query '[0].id' -o tsv 2>&1)\nif [ -z \"$SP_ID\" ] || [ \"$SP_ID\" = \"null\" ]; then\n  echo \"Creating service principal...\"\n  SP_ID=$(az ad sp create --id \"$APP_ID\" --query id -o tsv 2>&1)\n  if [ -z \"$SP_ID\" ] || [ \"$SP_ID\" = \"null\" ]; then\n    echo \"ERROR: Failed to create service principal\"\n    exit 1\n  fi\n  echo \"✓ Created service principal with ID: $SP_ID\"\n  sleep 15\nelse\n  echo \"✓ Found existing service principal with ID: $SP_ID\"\nfi\n\n# Reset/create client secret\necho \"\"\necho \"Generating new client secret...\"\nCLIENT_SECRET=$(az ad app credential reset --id \"$APP_ID\" --query password -o tsv)\nif [ -z \"$CLIENT_SECRET\" ]; then\n  echo \"ERROR: Failed to generate client secret\"\n  exit 1\nfi\necho \"✓ Client secret generated successfully\"\n\n# Wait for service principal propagation\necho \"\"\necho \"Waiting for service principal propagation...\"\nsleep 20\n\n# Assign Reader role at subscription scope\necho \"\"\necho \"Assigning Reader role at subscription scope...\"\nset +e\nEXISTING_ROLE=$(az role assignment list --assignee $SP_ID --role Reader --scope /subscriptions/$SUBSCRIPTION_ID --query '[0].id' -o tsv 2>&1)\nset -e\nif [ -z \"$EXISTING_ROLE\" ] || [ \"$EXISTING_ROLE\" = \"null\" ]; then\n  MAX_RETRIES=3\n  RETRY_COUNT=0\n  while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do\n    set +e\n    az role assignment create --assignee $SP_ID --role Reader --scope /subscriptions/$SUBSCRIPTION_ID 2>&1\n    RESULT=$?\n    set -e\n    if [ $RESULT -eq 0 ]; then\n      echo \"✓ Reader role assigned\"\n      break\n    else\n      RETRY_COUNT=$((RETRY_COUNT+1))\n      if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then\n        echo \"Retry $RETRY_COUNT/$MAX_RETRIES - waiting 10 seconds...\"\n        sleep 10\n      else\n        echo \"ERROR: Failed to assign Reader role after $MAX_RETRIES attempts\"\n        exit 1\n      fi\n    fi\n  done\nelse\n  echo \"✓ Reader role already assigned\"\nfi\n\n# Assign Management Group Reader role (non-critical)\necho \"\"\necho \"Assigning Management Group Reader role...\"\nMG_SCOPE=\"/providers/Microsoft.Management/managementGroups/$TENANT_ID\"\nset +e\nEXISTING_MG_ROLE=$(az role assignment list --assignee $SP_ID --role \"Management Group Reader\" --scope \"$MG_SCOPE\" --query '[0].id' -o tsv 2>&1)\nset -e\nif [ -z \"$EXISTING_MG_ROLE\" ] || [ \"$EXISTING_MG_ROLE\" = \"null\" ]; then\n  set +e\n  az role assignment create --assignee $SP_ID --role \"Management Group Reader\" --scope \"$MG_SCOPE\" 2>&1\n  MG_RESULT=$?\n  set -e\n  if [ $MG_RESULT -eq 0 ]; then\n    echo \"✓ Management Group Reader role assigned\"\n  else\n    echo \"⚠️  WARNING: Could not assign Management Group Reader role\"\n    echo \"   This may require additional permissions or manual assignment\"\n  fi\nelse\n  echo \"✓ Management Group Reader role already assigned\"\nfi\n\n# Assign AcrPull role to all ACR registries (non-critical)\necho \"\"\necho \"Checking for ACR registries...\"\nset +e\nACR_REGISTRIES=$(az acr list --subscription $SUBSCRIPTION_ID --query '[].id' -o tsv 2>&1)\nset -e\nif [ -z \"$ACR_REGISTRIES\" ]; then\n  echo \"No ACR registries found in subscription\"\nelse\n  echo \"Found ACR registries, assigning AcrPull role...\"\n  for ACR_ID in $ACR_REGISTRIES; do\n    echo \"Processing ACR: $ACR_ID\"\n    set +e\n    EXISTING_ACR_ROLE=$(az role assignment list --assignee $SP_ID --role AcrPull --scope $ACR_ID --query '[0].id' -o tsv 2>&1)\n    set -e\n    if [ -z \"$EXISTING_ACR_ROLE\" ] || [ \"$EXISTING_ACR_ROLE\" = \"null\" ]; then\n      set +e\n      az role assignment create --assignee $SP_ID --role AcrPull --scope $ACR_ID 2>&1\n      ACR_RESULT=$?\n      set -e\n      if [ $ACR_RESULT -eq 0 ]; then\n        echo \"✓ AcrPull role assigned for $ACR_ID\"\n      else\n        echo \"⚠️  WARNING: Could not assign AcrPull role for $ACR_ID\"\n      fi\n    else\n      echo \"✓ AcrPull role already assigned for $ACR_ID\"\n    fi\n  done\nfi\n\necho \"\"\necho \"======================================\"\necho \"Deployment script completed successfully!\"\necho \"======================================\"\n\n# Output results as JSON\nOUTPUT_JSON=\"{\\\"clientId\\\":\\\"$APP_ID\\\",\\\"clientSecret\\\":\\\"$CLIENT_SECRET\\\",\\\"servicePrincipalObjectId\\\":\\\"$SP_ID\\\"}\"\necho \"Writing outputs to: $AZ_SCRIPTS_OUTPUT_PATH\"\necho \"$OUTPUT_JSON\" > $AZ_SCRIPTS_OUTPUT_PATH\necho \"✓ Outputs written successfully\"",
        "environmentVariables": [
          {
            "name": "APP_DISPLAY_NAME",
            "value": "[parameters('applicationDisplayName')]"
          },
          {
            "name": "SUBSCRIPTION_ID",
            "value": "[subscription().subscriptionId]"
          }
        ]
      }
    }
  ],
  "outputs": {
    "clientId": {
      "type": "string",
      "value": "[reference('createAzureAdAppAndAssignRoles').outputs.clientId]"
    },
    "clientSecret": {
      "type": "string",
      "value": "[reference('createAzureAdAppAndAssignRoles').outputs.clientSecret]"
    },
    "tenantId": {
      "type": "string",
      "value": "[subscription().tenantId]"
    },
    "subscriptionId": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[parameters('storageAccountName')]"
    },
    "storageQueueName": {
      "type": "string",
      "value": "[parameters('storageQueueName')]"
    },
    "storageAccountKey": {
      "type": "string",
      "value": "[listKeys(variables('storageAccountId'), '2023-01-01').keys[0].value]"
    },
    "storageContainerName": {
      "type": "string",
      "value": "[parameters('storageContainerName')]"
    },
    "servicePrincipalObjectId": {
      "type": "string",
      "value": "[reference('createAzureAdAppAndAssignRoles').outputs.servicePrincipalObjectId]"
    }
  }
}
